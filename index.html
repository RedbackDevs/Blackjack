<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack 21</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2e7d32;
            color: white;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        #game-container {
            max-width: 1200px;
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hand-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .hand {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin: 10px;
            min-width: 220px;
        }
        .card {
            width: 80px;
            height: 120px;
            margin: 5px;
            border-radius: 5px;
            transition: transform 0.5s ease;
        }
        .card.dealt {
            animation: dealCard 0.5s ease;
        }
        @keyframes dealCard {
            from { transform: translateY(-100vh); }
            to { transform: translateY(0); }
        }
        #controls {
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #ffca28;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #message {
            font-size: 20px;
            margin: 15px;
            min-height: 24px;
        }
        #bankroll, #bet-display {
            font-size: 18px;
            margin: 10px;
        }
        #betting-area {
            margin: 20px;
        }
        #bet-input {
            padding: 10px;
            font-size: 16px;
            width: 100px;
        }
        .hand-value {
            font-size: 16px;
            margin-top: 5px;
        }
        .current-hand {
            border: 2px solid #ffca28;
        }
        @media (max-width: 600px) {
            .card { width: 60px; height: 90px; }
            .hand { min-width: 150px; }
            button { padding: 8px 16px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Blackjack 21</h1>
        <div id="dealer-hand" class="hand-container"></div>
        <div id="player-hands" class="hand-container"></div>
        <div id="message"></div>
        <div id="betting-area">
            <input type="number" id="bet-input" min="1" step="1" placeholder="Bet amount">
            <button id="start-button">Start Hand</button>
        </div>
        <div id="controls">
            <button id="hit-button" disabled>Hit</button>
            <button id="stand-button" disabled>Stand</button>
            <button id="double-button" disabled>Double Down</button>
            <button id="split-button" disabled>Split</button>
            <button id="insurance-button" disabled>Insurance</button>
            <button id="surrender-button" disabled>Surrender</button>
        </div>
        <div id="bankroll">Bankroll: $1000</div>
        <div id="bet-display">Current Bet: $0</div>
    </div>

    <script>
        const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
        const ranks = ['ace', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'jack', 'queen', 'king'];
        const NUM_DECKS = 1;
        const MAX_SPLITS = 4;

        class Card {
            constructor(suit, rank) {
                this.suit = suit;
                this.rank = rank;
            }
        }

        class Deck {
            constructor(numDecks = NUM_DECKS) {
                this.cards = [];
                for (let i = 0; i < numDecks; i++) {
                    for (let suit of suits) {
                        for (let rank of ranks) {
                            this.cards.push(new Card(suit, rank));
                        }
                    }
                }
            }
            shuffle() {
                for (let i = this.cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
                }
            }
            deal() {
                if (this.cards.length === 0) {
                    this.cards = new Deck().cards;
                    this.shuffle();
                }
                return this.cards.pop();
            }
        }

        class Hand {
            constructor() {
                this.cards = [];
            }
            addCard(card) {
                this.cards.push(card);
            }
            getValue() {
                let value = 0;
                let aces = 0;
                for (let card of this.cards) {
                    if (card.rank === 'ace') {
                        aces += 1;
                        value += 11;
                    } else if (['jack', 'queen', 'king'].includes(card.rank)) {
                        value += 10;
                    } else {
                        value += parseInt(card.rank);
                    }
                }
                while (value > 21 && aces > 0) {
                    value -= 10;
                    aces -= 1;
                }
                return value;
            }
            isPair() {
                return this.cards.length === 2 && this.cards[0].rank === this.cards[1].rank;
            }
            isBlackjack() {
                return this.cards.length === 2 && this.getValue() === 21;
            }
        }

        class Player {
            constructor(name, bankroll) {
                this.name = name;
                this.bankroll = bankroll;
                this.hands = [];
                this.totalBet = 0;
            }
            placeBet(amount) {
                if (amount > this.bankroll || amount <= 0) throw new Error('Invalid bet amount');
                this.bankroll -= amount;
                this.totalBet += amount;
                return amount;
            }
            win(amount) {
                this.bankroll += amount;
            }
        }

        class AIPlayer extends Player {
            constructor(name, bankroll) {
                super(name, bankroll);
            }
            decideAction(hand) {
                return hand.getValue() < 17 ? 'hit' : 'stand';
            }
        }

        class Dealer {
            constructor() {
                this.hand = new Hand();
            }
        }

        class Game {
            constructor() {
                this.reset();
            }
            reset() {
                this.deck = new Deck();
                this.deck.shuffle();
                this.players = [
                    new Player('Player', 1000),
                    new AIPlayer('AI 1', 1000),
                    new AIPlayer('AI 2', 1000),
                    new AIPlayer('AI 3', 1000),
                    new AIPlayer('AI 4', 1000)
                ];
                this.dealer = new Dealer();
                this.state = 'betting';
                this.currentPlayerIndex = 0;
                this.currentHandIndex = 0;
                this.insuranceBet = 0;
            }
            startHand(betAmount) {
                try {
                    this.players[0].hands = [{ hand: new Hand(), bet: this.players[0].placeBet(betAmount) }];
                    this.players.slice(1).forEach(ai => {
                        const aiBet = Math.min(100, ai.bankroll);
                        ai.hands = [{ hand: new Hand(), bet: ai.placeBet(aiBet) }];
                    });
                    this.dealer.hand = new Hand();
                    this.dealInitialCards();
                    this.state = 'dealing';
                    this.checkInitialConditions();
                    render();
                } catch (e) {
                    displayMessage(e.message);
                }
            }
            dealInitialCards() {
                this.players.forEach(player => {
                    player.hands[0].hand.addCard(this.deck.deal());
                    player.hands[0].hand.addCard(this.deck.deal());
                });
                this.dealer.hand.addCard(this.deck.deal());
                this.dealer.hand.addCard(this.deck.deal());
            }
            checkInitialConditions() {
                if (this.dealer.hand.cards[0].rank === 'ace') {
                    document.getElementById('insurance-button').disabled = false;
                    displayMessage('Dealer has Ace. Take insurance?');
                } else {
                    this.state = 'player_turn';
                    displayMessage('Your turn.');
                }
            }
            offerInsurance() {
                if (this.state === 'dealing' && this.dealer.hand.cards[0].rank === 'ace') {
                    const maxInsurance = this.players[0].hands[0].bet / 2;
                    const bet = parseFloat(prompt(`Enter insurance bet (up to $${maxInsurance})`)) || 0;
                    if (bet > maxInsurance || bet > this.players[0].bankroll) {
                        displayMessage('Invalid insurance bet.');
                        return;
                    }
                    this.insuranceBet = this.players[0].placeBet(bet);
                    this.checkDealerBlackjack();
                }
            }
            checkDealerBlackjack() {
                if (this.dealer.hand.isBlackjack()) {
                    if (this.insuranceBet > 0) {
                        this.players[0].win(3 * this.insuranceBet);
                        displayMessage('Dealer has Blackjack. Insurance pays.');
                    }
                    this.players.forEach(player => {
                        player.hands.forEach(hand => {
                            if (hand.hand.isBlackjack()) player.win(hand.bet);
                        });
                    });
                    this.state = 'hand_over';
                    displayMessage('Dealer has Blackjack. You lose.');
                } else {
                    if (this.insuranceBet > 0) displayMessage('Dealer does not have Blackjack. Insurance lost.');
                    this.players.forEach(player => {
                        player.hands.forEach(hand => {
                            if (hand.hand.isBlackjack()) player.win(2.5 * hand.bet);
                        });
                    });
                    this.state = 'player_turn';
                    displayMessage('Your turn.');
                }
                render();
            }
            hit() {
                if (this.state === 'player_turn' && this.currentPlayerIndex === 0) {
                    const currentHand = this.players[0].hands[this.currentHandIndex].hand;
                    currentHand.addCard(this.deck.deal());
                    if (currentHand.getValue() > 21) {
                        displayMessage(`Hand ${this.currentHandIndex + 1} busts!`);
                        this.nextHandOrPlayer();
                    }
                    render();
                }
            }
            stand() {
                if (this.state === 'player_turn' && this.currentPlayerIndex === 0) {
                    this.nextHandOrPlayer();
                    render();
                }
            }
            doubleDown() {
                if (this.state === 'player_turn' && this.currentPlayerIndex === 0 && this.players[0].hands[this.currentHandIndex].hand.cards.length === 2) {
                    const current = this.players[0].hands[this.currentHandIndex];
                    try {
                        const additionalBet = this.players[0].placeBet(current.bet);
                        current.bet += additionalBet;
                        current.hand.addCard(this.deck.deal());
                        this.nextHandOrPlayer();
                        render();
                    } catch (e) {
                        displayMessage('Not enough funds to double down.');
                    }
                }
            }
            split() {
                if (this.state === 'player_turn' && this.currentPlayerIndex === 0 && this.players[0].hands[this.currentHandIndex].hand.isPair() && this.players[0].hands.length < MAX_SPLITS) {
                    const current = this.players[0].hands[this.currentHandIndex];
                    try {
                        const newBet = this.players[0].placeBet(current.bet);
                        const newHand = new Hand();
                        newHand.addCard(current.hand.cards.pop());
                        this.players[0].hands.push({ hand: newHand, bet: newBet });
                        current.hand.addCard(this.deck.deal());
                        newHand.addCard(this.deck.deal());
                        render();
                    } catch (e) {
                        displayMessage('Not enough funds to split.');
                    }
                }
            }
            surrender() {
                if (this.state === 'player_turn' && this.currentPlayerIndex === 0 && this.players[0].hands[this.currentHandIndex].hand.cards.length === 2) {
                    const currentBet = this.players[0].hands[this.currentHandIndex].bet;
                    this.players[0].win(currentBet / 2);
                    this.players[0].hands.splice(this.currentHandIndex, 1);
                    displayMessage(`Hand ${this.currentHandIndex + 1} surrendered. Half bet returned.`);
                    if (this.players[0].hands.length === 0) this.nextPlayer();
                    else this.currentHandIndex = Math.min(this.currentHandIndex, this.players[0].hands.length - 1);
                    render();
                }
            }
            nextHandOrPlayer() {
                this.currentHandIndex++;
                if (this.currentHandIndex >= this.players[this.currentPlayerIndex].hands.length) {
                    this.nextPlayer();
                } else {
                    displayMessage(`Playing hand ${this.currentHandIndex + 1}.`);
                }
            }
            nextPlayer() {
                this.currentPlayerIndex++;
                this.currentHandIndex = 0;
                if (this.currentPlayerIndex >= this.players.length) {
                    this.dealerTurn();
                } else {
                    const player = this.players[this.currentPlayerIndex];
                    if (player instanceof AIPlayer) this.aiPlay(player);
                    else displayMessage(`Your turn.`);
                }
            }
            aiPlay(aiPlayer) {
                const aiHands = aiPlayer.hands;
                const playHand = (handIndex) => {
                    if (handIndex < aiHands.length) {
                        const hand = aiHands[handIndex].hand;
                        const action = aiPlayer.decideAction(hand);
                        if (action === 'hit') {
                            hand.addCard(this.deck.deal());
                            if (hand.getValue() > 21) setTimeout(() => playHand(handIndex + 1), 500);
                            else setTimeout(() => playHand(handIndex), 500);
                        } else {
                            setTimeout(() => playHand(handIndex + 1), 500);
                        }
                    } else {
                        this.nextPlayer();
                    }
                };
                playHand(0);
            }
            dealerTurn() {
                this.state = 'dealer_turn';
                displayMessage('Dealerâ€™s turn.');
                const dealCard = () => {
                    if (this.dealer.hand.getValue() < 17) {
                        this.dealer.hand.addCard(this.deck.deal());
                        render();
                        setTimeout(dealCard, 500);
                    } else {
                        this.determineWinners();
                    }
                };
                dealCard();
            }
            determineWinners() {
                this.state = 'hand_over';
                const dealerValue = this.dealer.hand.getValue();
                let message = '';
                this.players.forEach(player => {
                    player.hands.forEach(hand => {
                        const playerValue = hand.hand.getValue();
                        const bet = hand.bet;
                        if (playerValue > 21) message += `${player.name} Hand busts. Lose $${bet}. `;
                        else if (dealerValue > 21) {
                            player.win(2 * bet);
                            message += `${player.name} Hand: Dealer busts. Win $${bet}! `;
                        } else if (playerValue > dealerValue) {
                            player.win(2 * bet);
                            message += `${player.name} Hand: ${playerValue} beats ${dealerValue}. Win $${bet}! `;
                        } else if (playerValue < dealerValue) {
                            message += `${player.name} Hand: ${dealerValue} beats ${playerValue}. Lose $${bet}. `;
                        } else {
                            player.win(bet);
                            message += `${player.name} Hand: Push at ${playerValue}. `;
                        }
                    });
                });
                displayMessage(message.trim());
                render();
            }
        }

        const game = new Game();

        function render() {
            const dealerHandDiv = document.getElementById('dealer-hand');
            dealerHandDiv.innerHTML = '<div class="hand"><div class="hand-value">Dealer: ' + 
                (game.state === 'player_turn' || game.state === 'dealing' ? '?' : game.dealer.hand.getValue()) + 
                '</div></div>';
            const dealerInner = dealerHandDiv.querySelector('.hand');
            if (game.state === 'player_turn' || game.state === 'dealing') {
                dealerInner.appendChild(createCardImage(game.dealer.hand.cards[0]));
                dealerInner.appendChild(createCardImage('back'));
            } else {
                game.dealer.hand.cards.forEach(card => dealerInner.appendChild(createCardImage(card)));
            }

            const playerHandsDiv = document.getElementById('player-hands');
            playerHandsDiv.innerHTML = '';
            game.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'hand';
                if (player === game.players[game.currentPlayerIndex] && game.state === 'player_turn') {
                    playerDiv.classList.add('current-hand');
                }
                playerDiv.innerHTML = `<div class="hand-value">${player.name}: ${player.hands[0].hand.getValue()} (Bet: $${player.hands[0].bet})</div>`;
                player.hands.forEach(hand => hand.hand.cards.forEach(card => playerDiv.appendChild(createCardImage(card))));
                playerHandsDiv.appendChild(playerDiv);
            });

            document.getElementById('bankroll').textContent = `Bankroll: $${game.players[0].bankroll}`;
            document.getElementById('bet-display').textContent = `Current Bet: $${game.players[0].totalBet}`;

            const isPlayerTurn = game.state === 'player_turn' && game.currentPlayerIndex === 0;
            const currentHand = game.players[0].hands[game.currentHandIndex]?.hand;
            document.getElementById('start-button').disabled = game.state !== 'betting' && game.state !== 'hand_over';
            document.getElementById('hit-button').disabled = !isPlayerTurn;
            document.getElementById('stand-button').disabled = !isPlayerTurn;
            document.getElementById('double-button').disabled = !isPlayerTurn || !currentHand || currentHand.cards.length !== 2 || game.players[0].bankroll < currentHand.bet;
            document.getElementById('split-button').disabled = !isPlayerTurn || !currentHand || !currentHand.isPair() || game.players[0].hands.length >= MAX_SPLITS || game.players[0].bankroll < currentHand.bet;
            document.getElementById('insurance-button').disabled = game.state !== 'dealing' || game.dealer.hand.cards[0].rank !== 'ace';
            document.getElementById('surrender-button').disabled = !isPlayerTurn || !currentHand || currentHand.cards.length !== 2;
        }

        function createCardImage(card) {
            const img = document.createElement('img');
            img.className = 'card dealt';
            img.src = card === 'back' ? 'cards/back.png' : `cards/${card.rank}_of_${card.suit}.png`;
            return img;
        }

        function displayMessage(text) {
            document.getElementById('message').textContent = text;
        }

        document.getElementById('start-button').addEventListener('click', () => {
            const betAmount = parseInt(document.getElementById('bet-input').value);
            game.startHand(betAmount);
            document.getElementById('bet-input').value = '';
        });
        document.getElementById('hit-button').addEventListener('click', () => game.hit());
        document.getElementById('stand-button').addEventListener('click', () => game.stand());
        document.getElementById('double-button').addEventListener('click', () => game.doubleDown());
        document.getElementById('split-button').addEventListener('click', () => game.split());
        document.getElementById('insurance-button').addEventListener('click', () => game.offerInsurance());
        document.getElementById('surrender-button').addEventListener('click', () => game.surrender());

        render();
    </script>
</body>
</html>